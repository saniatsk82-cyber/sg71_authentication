<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SG71 Authorization System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#4361ee;--primary-dark:#3a56d4;--secondary:#6c63ff;--success:#06d6a0;
      --danger:#ef476f;--warning:#ffd166;--dark:#1e1e2e;--darker:#12121a;--light:#f8f9fa;
      --gray:#8a8a9c;--card-bg:rgba(255,255,255,.07);--card-border:rgba(255,255,255,.1);
      --header-height:70px;--border-radius:12px;--transition:.3s ease all;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
    body{background:linear-gradient(135deg,var(--darker) 0%,var(--dark) 100%);color:var(--light);min-height:100vh;line-height:1.6}

    /* Login */
    .login-container{display:flex;align-items:center;justify-content:center;min-height:100vh;width:100%;padding:20px;background:linear-gradient(135deg,var(--darker),var(--dark))}
    .login-card{width:100%;max-width:400px;background:var(--card-bg);backdrop-filter:blur(10px);border:1px solid var(--card-border);border-radius:var(--border-radius);padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.3)}
    .login-logo{text-align:center;margin-bottom:30px}
    .logo-icon{width:60px;height:60px;background:var(--primary);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto}
    .login-title{font-size:24px;font-weight:700;text-align:center;margin:15px 0 30px;background:linear-gradient(to right,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:500;display:flex;align-items:center;gap:8px}
    .form-input{width:100%;background:rgba(0,0,0,.1);border:1px solid var(--card-border);border-radius:var(--border-radius);padding:12px 15px;color:var(--light);transition:var(--transition)}
    .form-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(67,97,238,.2)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:var(--border-radius);border:none;font-weight:500;cursor:pointer;transition:var(--transition)}
    .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px)}
    .btn-danger{background:var(--danger);color:#fff}.btn-success{background:var(--success);color:#fff}
    .btn-warning{background:var(--warning);color:var(--dark)} .btn-sm{padding:8px 12px;font-size:14px}
    /* Nicer tiny icon buttons + tooltip */
.icon-btn{
  --ring: rgba(255,255,255,.08);
  display:inline-flex;align-items:center;justify-content:center;
  width:30px;height:30px;border-radius:8px;
  background:rgba(255,255,255,.04);border:1px solid var(--card-border);
  cursor:pointer;transition:transform .15s ease, background .2s ease, border-color .2s ease;
}
.icon-btn i{font-size:14px;opacity:.9}
.icon-btn:hover{background:var(--ring);border-color:rgba(255,255,255,.2);transform:translateY(-1px)}
.icon-edit:hover{background:rgba(67,97,238,.12);border-color:rgba(67,97,238,.35)}
.icon-delete:hover{background:rgba(239,71,111,.12);border-color:rgba(239,71,111,.35)}
.icon-btn:active{transform:translateY(0) scale(.98)}

/* small tooltip (pure CSS) */
.icon-btn[data-tip]{position:relative}
.icon-btn[data-tip]::after{
  content:attr(data-tip); position:absolute; bottom:115%; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.85); color:#fff; padding:4px 8px; border-radius:6px;
  font-size:11px; white-space:nowrap; opacity:0; pointer-events:none; transition:opacity .15s ease;
}
.icon-btn[data-tip]:hover::after{opacity:1}


    /* App */
    .app-container{display:none;width:100%;min-height:100vh}
    .header{height:var(--header-height);background:rgba(30,30,46,.5);backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);padding:0 30px;display:flex;align-items:center;justify-content:space-between}
    .header-title{display:flex;align-items:center;gap:12px;font-weight:600;font-size:18px}
    .header-title i{color:var(--primary)}
    .user-menu{display:flex;align-items:center;gap:15px}
    .user-info{display:flex;align-items:center;gap:10px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:600}
    .header-actions{display:flex;gap:15px}
    .header-actions button{background:var(--card-bg);border:none;width:40px;height:40px;border-radius:50%;color:var(--light);cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center}
    .header-actions button:hover{background:var(--primary)}

    .content{padding:30px;display:grid;grid-template-columns:1fr 1fr;gap:25px}
    @media (max-width:992px){.content{grid-template-columns:1fr}}
    .card{background:var(--card-bg);backdrop-filter:blur(10px);border:1px solid var(--card-border);border-radius:var(--border-radius);padding:20px;transition:var(--transition)}
    .card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid var(--card-border)}
    .card-title{font-weight:600;font-size:18px;display:flex;align-items:center;gap:10px}
    .card-title i{color:var(--primary)}
    .table-container{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--border-radius);overflow:hidden;margin-bottom:20px}
    .table-header{padding:20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--card-border)}
    .table-title{font-weight:600;font-size:18px;display:flex;align-items:center;gap:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:15px 20px;text-align:left;border-bottom:1px solid var(--card-border)}
    th{font-weight:500;color:var(--gray);background:rgba(0,0,0,.1)}
    tr:last-child td{border-bottom:none}
    tr:hover{background:rgba(67,97,238,.05)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px}
    .badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500}
    .badge-success{background:rgba(6,214,160,.2);color:var(--success)}
    .badge-danger{background:rgba(239,71,111,.2);color:var(--danger)}
    .badge-warning{background:rgba(255,209,102,.2);color:var(--warning)}
    .btn-group{display:flex;gap:10px;flex-wrap:wrap;margin:15px 0}
    .notification{padding:15px;border-radius:var(--border-radius);margin:15px 0;display:none}
    .notification-success{background:rgba(6,214,160,.2);color:var(--success);border:1px solid rgba(6,214,160,.3)}
    .notification-error{background:rgba(239,71,111,.2);color:var(--danger);border:1px solid rgba(239,71,111,.3)}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:15px 0}
    .stat-card{background:rgba(0,0,0,.1);padding:15px;border-radius:var(--border-radius);text-align:center}
    .stat-value{font-size:24px;font-weight:700;margin:5px 0;color:var(--primary)}
    .stat-label{color:var(--gray);font-size:14px}
    .app-info-panel{background:rgba(0,0,0,.1);border-radius:var(--border-radius);padding:15px;margin-bottom:20px;border:1px solid var(--card-border)}
    .app-info-row{display:flex;margin-bottom:10px;align-items:center}
    .app-info-label{font-weight:600;min-width:120px;color:var(--primary)}
    .app-info-value{flex:1;word-break:break-all}
    .text-gray{color:var(--gray)} .mb-20{margin-bottom:20px}

    /* Tabs */
    .tab-container{display:flex;border-bottom:1px solid var(--card-border);margin-bottom:25px;padding:0 30px}
    .tab{padding:15px 25px;cursor:pointer;border-bottom:3px solid transparent;font-weight:500;transition:var(--transition)}
    .tab.active{border-bottom:3px solid var(--primary);color:var(--primary)}
    .tab-content{display:none}.tab-content.active{display:block}

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--border-radius);padding:25px;width:90%;max-width:500px;backdrop-filter:blur(10px)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--card-border)}
    .modal-title{font-weight:600;font-size:20px;display:flex;align-items:center;gap:10px}
    .close-modal{background:none;border:none;color:var(--light);font-size:24px;cursor:pointer}

    /* License list */
    .license-list{margin-top:15px;max-height:340px;overflow-y:auto;background:rgba(0,0,0,.1);border-radius:var(--border-radius);padding:10px}
    .license-item{padding:10px;border-bottom:1px solid var(--card-border);font-family:monospace;display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .license-item:last-child{border-bottom:none}
    .copy-btn{background:var(--primary);border:none;border-radius:4px;color:#fff;padding:4px 8px;cursor:pointer;font-size:12px}
    .row-actions{display:flex;gap:6px}
    .btn-outline{background:transparent;border:1px solid var(--card-border);color:var(--light);border-radius:6px;padding:6px 10px;cursor:pointer}
    .btn-outline:hover{border-color:var(--primary)}
    .tiny{font-size:12px;color:var(--gray)}

    @media (max-width:768px){
      .content{padding:15px}
      .form-row{grid-template-columns:1fr}
      .tab-container{padding:0 15px}
      .tab{padding:10px 15px;font-size:14px}
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-logo">
        <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
        <h1 class="login-title">SG71 Auth System</h1>
      </div>

      <div id="loginNotification" class="notification notification-error">Invalid email or password. Please try again.</div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-envelope"></i> Email Address</label>
        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
      </div>
      <div class="form-group">
        <label class="form-label"><i class="fas fa-lock"></i> Password</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password">
      </div>
      <button class="btn btn-primary" id="btnLogin" style="width:100%"><i class="fas fa-sign-in-alt"></i> Sign In</button>

      <div class="mb-20" style="text-align:center;color:var(--gray);margin-top:20px">
        SG71 DEVELOPER ZONE
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="appPage" class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <i class="fas fa-shield-alt"></i>
        SG71 Authorization System <span id="currentFile">— No App Selected</span>
      </div>
      <div class="user-menu">
        <div class="header-actions">
          <button id="themeToggle"><i class="fas fa-moon"></i></button>
          <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div class="user-info">
          <div class="user-avatar"><i class="fas fa-user"></i></div>
          <div>
            <div>Admin User</div>
            <div class="text-gray" id="userEmail"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tab-container">
      <div class="tab active" data-tab="apps">Applications</div>
      <div class="tab" data-tab="licenses">Licenses</div>
      <div class="tab" data-tab="admin">Admin Management</div>
    </div>

    <!-- Applications Tab -->
    <div class="tab-content active" id="appsTab">
      <div class="content">
        <!-- Application Management -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-cogs"></i> Application Management</div>
          </div>

          <!-- App Info -->
          <div id="appInfoPanel" class="app-info-panel" style="display:none">
            <div class="app-info-row"><div class="app-info-label">App Name:</div><div class="app-info-value" id="infoAppName">-</div></div>
            <div class="app-info-row"><div class="app-info-label">Owner:</div><div class="app-info-value" id="infoOwner">-</div></div>
            <div class="app-info-row"><div class="app-info-label">App ID:</div><div class="app-info-value" id="infoCollection">-</div></div>
            <div class="app-info-row"><div class="app-info-label">App Version:</div><div class="app-info-value" id="infoAppVersion">-</div></div>
            <div class="app-info-row"><div class="app-info-label">HWID Check:</div><div class="app-info-value" id="infoCheckHWID">-</div></div>
          </div>

          <input type="text" class="form-input mb-20" id="fileName" placeholder="Application name">

          <div class="btn-group">
            <button class="btn btn-primary" id="btnCreateFile"><i class="fas fa-plus"></i> Create</button>
            <button class="btn btn-primary" id="btnRefreshFiles"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="btn btn-danger" id="btnDeleteFile" disabled><i class="fas fa-trash"></i> Delete</button>
            <button class="btn btn-warning" id="btnEditSettings" disabled><i class="fas fa-cog"></i> Edit Settings</button>
          </div>

          <div class="btn-group">
            <button class="btn btn-warning" id="btnPause"><i class="fas fa-pause"></i> Pause</button>
            <button class="btn btn-success" id="btnResume"><i class="fas fa-play"></i> Resume</button>
          </div>

          <div class="table-container">
            <div class="table-header">
              <div class="table-title"><i class="fas fa-list"></i> Applications</div>
            </div>
            <table id="filesTable">
              <thead><tr><th>App</th><th>Status</th></tr></thead>
              <tbody><!-- JS fills --></tbody>
            </table>
          </div>
        </div>

        <!-- User Management -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-users"></i> User Management</div>
            <button class="btn btn-primary" id="btnAddUserModal"><i class="fas fa-plus"></i> Add User</button>
          </div>

          <div class="stats">
            <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Users</div></div>
            <div class="stat-card"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
            <div class="stat-card"><div class="stat-value" id="statBanned">0</div><div class="stat-label">Banned</div></div>
            <div class="stat-card"><div class="stat-value" id="statExpired">0</div><div class="stat-label">Expired</div></div>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" id="btnResetHWID" disabled><i class="fas fa-key"></i> Reset HWID</button>
            <button class="btn btn-danger" id="btnBan" disabled><i class="fas fa-ban"></i> Ban</button>
            <button class="btn btn-success" id="btnUnban" disabled><i class="fas fa-check-circle"></i> Unban</button>
          </div>

          <input type="text" class="form-input mb-20" id="search" placeholder="Search user...">

          <div id="userNotification" class="notification notification-success">User operation completed successfully.</div>

          <div class="table-container">
            <div class="table-header">
              <div class="table-title"><i class="fas fa-users"></i> Users</div>
              <div>Total: <span id="userCount">0</span></div>
            </div>
            <table id="usersTable">
              <thead>
                <tr><th>Username</th><th>HWID</th><th>Expires</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody><!-- JS fills --></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Licenses Tab -->
    <div class="tab-content" id="licensesTab">
      <div class="content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-key"></i> License Generation
              <span id="licenseAppInfo" class="text-gray" style="margin-left:10px"></span>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" id="btnOpenLicenseModal"><i class="fas fa-plus"></i> Generate</button>
              <button class="btn btn-warning" id="btnRefreshLicenses"><i class="fas fa-sync-alt"></i> Refresh</button>
              <button class="btn btn-outline" id="btnExportCsv"><i class="fas fa-file-export"></i> Export CSV</button>
            </div>
          </div>

          <div class="form-row">
            <input class="form-input" id="licenseSearch" placeholder="Search license key...">
            <div style="display:flex;align-items:center;gap:10px">
              <span class="text-gray">Total:</span><span id="licenseTotal">0</span>
            </div>
          </div>

          <div id="licenseNotification" class="notification notification-success">Licenses loaded.</div>

          <div id="licenseList" class="license-list" style="display:none">
            <h4 style="margin-bottom:8px">All Licenses</h4>
            <div id="licenseItems"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Tab -->
    <div class="tab-content" id="adminTab">
      <div class="content">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-user-shield"></i> Admin Management</div>
          </div>

          <div id="adminNotification" class="notification notification-success">Admin operation completed successfully.</div>

          <div class="form-row">
            <input type="email" class="form-input" id="adminEmail" placeholder="Admin email">
            <input type="password" class="form-input" id="adminPassword" placeholder="Password">
          </div>

          <select class="form-input" id="adminRoleSelect">
            <option value="admin">Administrator</option>
            <option value="moderator">Moderator</option>
          </select>

          <div class="btn-group">
            <button class="btn btn-primary" id="btnAddAdmin"><i class="fas fa-plus"></i> Add Admin</button>
            <button class="btn btn-primary" id="btnUpdateAdmin" disabled><i class="fas fa-edit"></i> Update Role</button>
            <button class="btn btn-danger" id="btnDeleteAdmin" disabled><i class="fas fa-trash"></i> Remove Admin</button>
          </div>

          <div class="table-container">
            <div class="table-header"><div class="table-title"><i class="fas fa-list"></i> Administrators</div></div>
            <table id="adminTable">
              <thead><tr><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
              <tbody><!-- JS fills --></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- App Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-cog"></i> App Settings</div>
        <button class="close-modal">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-code-branch"></i> App Version</label>
        <input type="text" class="form-input" id="appVersionInput" placeholder="App version">
      </div>

      <div class="form-group" style="margin-top:8px">
        <span style="margin-right:10px">HWID Check</span>
        <label class="toggle-switch">
          <input type="checkbox" id="hwidCheckToggle"><span class="toggle-slider"></span>
        </label>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="btnSaveSettings"><i class="fas fa-save"></i> Save Settings</button>
        <button class="btn btn-danger" id="btnCloseModal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-user"></i> <span id="userModalTitle">Add User</span></div>
        <button class="close-modal">&times;</button>
      </div>

      <div class="form-group"><label class="form-label"><i class="fas fa-user"></i> Username</label><input type="text" class="form-input" id="modalUsername" placeholder="Username"></div>
      <div class="form-group"><label class="form-label"><i class="fas fa-lock"></i> Password</label><input type="password" class="form-input" id="modalPassword" placeholder="Password"></div>
      <div class="form-group"><label class="form-label"><i class="fas fa-calendar"></i> Expiry Date</label><input type="date" class="form-input" id="modalExpires"></div>
      <div class="form-group"><label class="form-label"><i class="fas fa-microchip"></i> HWID (optional)</label><input type="text" class="form-input" id="modalHwid" placeholder="HWID"></div>

      <div class="btn-group">
        <button class="btn btn-primary" id="btnSaveUser"><i class="fas fa-save"></i> Save User</button>
        <button class="btn btn-danger" id="btnCancelUser">Cancel</button>
      </div>
    </div>
  </div>

  <!-- License Modal -->
  <div id="licenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-key"></i> Generate Licenses</div>
        <button class="close-modal">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-hashtag"></i> Quantity</label>
        <input type="number" class="form-input" id="modalLicenseQty" placeholder="How many?" min="1" max="100" value="5">
      </div>
      <div class="form-group">
        <label class="form-label"><i class="fas fa-tag"></i> Prefix (optional)</label>
        <input type="text" class="form-input" id="modalLicensePrefix" placeholder="e.g. VIP, BETA">
      </div>
      <div class="form-group">
        <label class="form-label"><i class="fas fa-calendar-alt"></i> Expiry (optional)</label>
        <input type="date" class="form-input" id="modalLicenseExpires">
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="btnSaveLicenses"><i class="fas fa-save"></i> Generate</button>
        <button class="btn btn-danger" id="btnCancelLicenses">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOz_5UptcilUG0F-V_9XKa2FdeSB0j7lo",
      authDomain: "sg71-auth-system.firebaseapp.com",
      projectId: "sg71-auth-system",
      storageBucket: "sg71-auth-system.appspot.com",
      messagingSenderId: "319458724065",
      appId: "1:319458724065:web:66bab397bc149b9e14cfa0",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const loginPage = document.getElementById('loginPage');
    const appPage = document.getElementById('appPage');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginNotification = document.getElementById('loginNotification');
    const btnLogin = document.getElementById('btnLogin');
    const themeToggle = document.getElementById('themeToggle');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');

    const filesTableBody = document.querySelector('#filesTable tbody');
    const usersTableBody = document.querySelector('#usersTable tbody');
    const userCount = document.getElementById('userCount');
    const currentFile = document.getElementById('currentFile');
    const inpSearch = document.getElementById('search');
    const btnBan = document.getElementById('btnBan');
    const btnUnban = document.getElementById('btnUnban');
    const btnResetHWID = document.getElementById('btnResetHWID');
    const btnCreateFile = document.getElementById('btnCreateFile');
    const inpFileName = document.getElementById('fileName');
    const btnDeleteFile = document.getElementById('btnDeleteFile');
    const btnRefreshFiles = document.getElementById('btnRefreshFiles');
    const btnPause = document.getElementById('btnPause');
    const btnResume = document.getElementById('btnResume');
    const btnEditSettings = document.getElementById('btnEditSettings');
    const userNotification = document.getElementById('userNotification');
    const statTotal = document.getElementById('statTotal');
    const statActive = document.getElementById('statActive');
    const statBanned = document.getElementById('statBanned');
    const statExpired = document.getElementById('statExpired');

    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // Licenses elements
    const btnOpenLicenseModal = document.getElementById('btnOpenLicenseModal');
    const btnRefreshLicenses = document.getElementById('btnRefreshLicenses');
    const btnExportCsv = document.getElementById('btnExportCsv');
    const licenseNotification = document.getElementById('licenseNotification');
    const licenseList = document.getElementById('licenseList');
    const licenseItems = document.getElementById('licenseItems');
    const licenseSearch = document.getElementById('licenseSearch');
    const licenseTotal = document.getElementById('licenseTotal');
    const licenseAppInfo = document.getElementById('licenseAppInfo');

    // Admin tab
    const adminEmail = document.getElementById('adminEmail');
    const adminPassword = document.getElementById('adminPassword');
    const adminRoleSelect = document.getElementById('adminRoleSelect');
    const btnAddAdmin = document.getElementById('btnAddAdmin');
    const btnUpdateAdmin = document.getElementById('btnUpdateAdmin');
    const btnDeleteAdmin = document.getElementById('btnDeleteAdmin');
    const adminTableBody = document.querySelector('#adminTable tbody');
    const adminNotification = document.getElementById('adminNotification');

    // Settings modal
    const settingsModal = document.getElementById('settingsModal');
    const appVersionInput = document.getElementById('appVersionInput');
    const hwidCheckToggle = document.getElementById('hwidCheckToggle');
    const btnSaveSettings = document.getElementById('btnSaveSettings');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const closeModalBtn = settingsModal.querySelector('.close-modal');

    // User modal
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const modalUsername = document.getElementById('modalUsername');
    const modalPassword = document.getElementById('modalPassword');
    const modalExpires = document.getElementById('modalExpires');
    const modalHwid = document.getElementById('modalHwid');
    const btnSaveUser = document.getElementById('btnSaveUser');
    const btnCancelUser = document.getElementById('btnCancelUser');
    const closeUserModalBtn = userModal.querySelector('.close-modal');

    // License modal
    const licenseModal = document.getElementById('licenseModal');
    const btnSaveLicenses = document.getElementById('btnSaveLicenses');
    const btnCancelLicenses = document.getElementById('btnCancelLicenses');
    const closeLicenseModalBtn = licenseModal.querySelector('.close-modal');
    const modalLicenseQty = document.getElementById('modalLicenseQty');
    const modalLicensePrefix = document.getElementById('modalLicensePrefix');
    const modalLicenseExpires = document.getElementById('modalLicenseExpires');

    let selectedFile = null, selectedUsername = null, filterText = "";
    let currentUser = null;
    let currentAdminRole = "user";
    let selectedAdmin = null;
    let isEditingUser = false;
    let licenseFilter = "";

    /* Tabs */
    tabs.forEach(tab=>{
      tab.addEventListener('click',()=>{
        const tabId = tab.getAttribute('data-tab');
        tabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        tabContents.forEach(c=>{
          c.classList.remove('active');
          if(c.id === `${tabId}Tab`) c.classList.add('active');
        });
        if(tabId === 'licenses'){ renderLicenses(); }
      });
    });

    /* Firestore helpers */
    const ls = {
      async readAllFiles(adminId){
        const snap = await getDocs(collection(db,"admins",adminId,"apps"));
        return snap.docs.map(d=>({name:d.id,data:d.data()}));
      },
      async readFile(adminId,name){
        const d = await getDoc(doc(db,"admins",adminId,"apps",name));
        if(!d.exists()) return {users:[], licenses:[], root:{}};
        return d.data();
      },
      async writeFile(adminId,name,payload){
        await setDoc(doc(db,"admins",adminId,"apps",name),payload);
      },
      async deleteFile(adminId,name){
        await deleteDoc(doc(db,"admins",adminId,"apps",name));
      },
      async updateFile(adminId,name,updates){
        await updateDoc(doc(db,"admins",adminId,"apps",name),updates);
      },
      async getAdmins(){
        const snap = await getDocs(collection(db,"admins"));
        const arr=[];
        for(const ds of snap.docs){
          const ad=ds.data(); arr.push({id:ds.id,email:ad.email,role:ad.role||"moderator",createdAt:ad.createdAt});
        }
        return arr;
      },
      async addAdmin(email,password,role){
        const cred = await createUserWithEmailAndPassword(auth,email,password);
        await setDoc(doc(db,"admins",cred.user.uid),{email,role,createdAt:serverTimestamp()});
        return cred.user;
      },
      async updateAdmin(adminId,updates){ await updateDoc(doc(db,"admins",adminId),updates); },
      async deleteAdmin(adminId){ await deleteDoc(doc(db,"admins",adminId)); },
      async getAdmin(adminId){
        const d=await getDoc(doc(db,"admins",adminId)); if(!d.exists()) return null;
        return {id:d.id,...d.data()};
      },
      async addLicenses(adminId,appName,licenses){
        const appRef = doc(db,"admins",adminId,"apps",appName);
        const appSnap = await getDoc(appRef);
        if(!appSnap.exists()) throw new Error("App does not exist");
        const data = appSnap.data();
        if(!data.licenses) data.licenses=[];
        data.licenses = [...data.licenses, ...licenses];
        await updateDoc(appRef,{licenses:data.licenses});
        return data.licenses;
      }
    };

    /* Utils */
    function showNotification(el,msg,isError=false){
      el.textContent = msg; el.style.display='block';
      if(isError){ el.classList.remove('notification-success'); el.classList.add('notification-error'); }
      else { el.classList.remove('notification-error'); el.classList.add('notification-success'); }
      setTimeout(()=>{ el.style.display='none'; },3000);
    }
    function setUserBtnsEnabled(en){ [btnBan,btnUnban,btnResetHWID].forEach(b=>b.disabled=!en); }
    function clearUserSelection(){
      selectedUsername=null; setUserBtnsEnabled(false);
      [...usersTableBody.querySelectorAll("tr")].forEach(r=>r.classList.remove("selected"));
    }
    function updateUserStats(){
      if(!selectedFile){ statTotal.textContent='0';statActive.textContent='0';statBanned.textContent='0';statExpired.textContent='0';return;}
      const users = selectedFile.data.users||[]; const now = new Date();
      statTotal.textContent = users.length;
      statActive.textContent = users.filter(u=>!u.IsBanned && (!u.Expires || new Date(u.Expires)>now)).length;
      statBanned.textContent = users.filter(u=>u.IsBanned).length;
      statExpired.textContent = users.filter(u=>!u.IsBanned && u.Expires && new Date(u.Expires)<=now).length;
    }
    function updateAppInfo(){
      const p = document.getElementById('appInfoPanel');
      if(selectedFile){
        p.style.display='block';
        document.getElementById('infoAppName').textContent = selectedFile.name;
        document.getElementById('infoOwner').textContent = selectedFile.ownerEmail || 'Unknown';
        document.getElementById('infoCollection').textContent = `${selectedFile.adminId}`;
        const appVersion = selectedFile.data.root?.AppVersion || '1.0';
        const checkHWID = selectedFile.data.root?.CheckHWID !== false;
        document.getElementById('infoAppVersion').textContent = appVersion;
        const el = document.getElementById('infoCheckHWID');
        el.textContent = checkHWID ? 'Enabled' : 'Disabled';
        el.className = checkHWID ? 'app-info-value text-success' : 'app-info-value text-danger';
        btnEditSettings.disabled = false;
      }else{
        p.style.display='none'; btnEditSettings.disabled=true;
      }
      // licenses header
      licenseAppInfo.textContent = selectedFile ? `for "${selectedFile.name}"` : '';
    }
    function generateLicenseKey(appName){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let key=appName.toUpperCase().replace(/\s+/g,'')+'-';
      for(let i=0;i<16;i++){ key += chars.charAt(Math.floor(Math.random()*chars.length)); if(i===3||i===7||i===11) key+='-'; }
      return key;
    }

    /* Render Users */
    function renderUsers(){
      usersTableBody.innerHTML='';
      if(!selectedFile){ userCount.textContent='0'; updateUserStats(); return; }
      const users = selectedFile.data.users||[];
      const filtered = users.filter(u=>u.Username && u.Username.toLowerCase().includes(filterText.toLowerCase()));
      userCount.textContent = filtered.length;

      filtered.forEach(u=>{
        const tr=document.createElement('tr');
        let status='Active', cls='badge-success';
        if(u.IsBanned){ status='Banned'; cls='badge-danger'; }
        else if(u.Expires && new Date(u.Expires)<=new Date()){ status='Expired'; cls='badge-warning'; }
        tr.innerHTML = `
          <td>${u.Username}</td>
          <td>${u.HWID ? u.HWID.substring(0,8)+'...' : 'Not set'}</td>
          <td>${u.Expires || 'Never'}</td>
          <td><span class="badge ${cls}">${status}</span></td>
          <td class="user-actions">
            <button class="action-btn edit" data-username="${u.Username}"><i class="fas fa-edit"></i></button>
            <button class="action-btn delete" data-username="${u.Username}"><i class="fas fa-trash"></i></button>
          </td>`;
        tr.addEventListener('click',(e)=>{
          if(!e.target.closest('.user-actions')){
            selectedUsername=u.Username; setUserBtnsEnabled(true);
            [...usersTableBody.querySelectorAll("tr")].forEach(r=>r.classList.remove("selected"));
            tr.classList.add("selected");
          }
        });
        usersTableBody.appendChild(tr);
      });

      document.querySelectorAll('.action-btn.edit').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          e.stopPropagation(); openUserModal(btn.getAttribute('data-username'));
        });
      });
      document.querySelectorAll('.action-btn.delete').forEach(btn=>{
        btn.addEventListener('click',async (e)=>{
          e.stopPropagation();
          const username = btn.getAttribute('data-username');
          if(!confirm(`Are you sure you want to delete user "${username}"?`)) return;
          selectedFile.data.users = selectedFile.data.users.filter(x=>x.Username!==username);
          await saveUsers(); clearUserSelection();
        });
      });

      setUserBtnsEnabled(!!selectedUsername);
      updateUserStats();
    }

    /* Render Licenses + actions */
    function renderLicenses(){
      licenseItems.innerHTML = '';
      if(!selectedFile){
        licenseList.style.display='none';
        licenseTotal.textContent = '0';
        showNotification(licenseNotification,"Select an application to view licenses",true);
        licenseAppInfo.textContent = '';
        return;
      }
      const all = (selectedFile.data.licenses || []).slice().reverse(); // latest first
      const filtered = all.filter(l => !licenseFilter || (l.key && l.key.toLowerCase().includes(licenseFilter.toLowerCase())));
      licenseTotal.textContent = all.length.toString();

      if(filtered.length === 0){
        licenseList.style.display='block';
        licenseItems.innerHTML = `<div class="text-gray" style="padding:8px">No licenses found${licenseFilter ? ' for current search' : ''}.</div>`;
        return;
      }

      filtered.forEach(license=>{
        const wrap=document.createElement('div');
        const exp = license.expires ? ` &nbsp;<span class="tiny">(exp: ${license.expires})</span>` : '';
        const used = license.used ? ` &nbsp;<span class="badge badge-warning">USED</span>` : '';
        wrap.className='license-item';
        wrap.innerHTML = `
          <span>${license.key}${exp}${used}</span>
          <div class="row-actions">
            <button class="copy-btn" data-key="${license.key}" title="Copy key"><i class="fas fa-copy"></i></button>
            <button class="btn-outline toggle-used" data-key="${license.key}">${license.used?'Mark Unused':'Mark Used'}</button>
            <button class="btn-outline text-danger delete-license" data-key="${license.key}"><i class="fas fa-trash"></i> Delete</button>
          </div>`;
        licenseItems.appendChild(wrap);
      });

      // copy
      document.querySelectorAll('.copy-btn').forEach(b=>{
        b.addEventListener('click',()=>{
          const key=b.getAttribute('data-key');
          navigator.clipboard.writeText(key).then(()=>{ b.innerHTML='<i class="fas fa-check"></i>'; setTimeout(()=>b.innerHTML='<i class="fas fa-copy"></i>',1200); });
        });
      });

      // toggle used
      document.querySelectorAll('.toggle-used').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const key = btn.getAttribute('data-key');
          const arr = selectedFile.data.licenses || [];
          const idx = arr.findIndex(x=>x.key===key);
          if(idx>-1){
            arr[idx].used = !arr[idx].used;
            await persistLicenses(arr, `Marked ${arr[idx].used?'used':'unused'}`);
          }
        });
      });

      // delete license
      document.querySelectorAll('.delete-license').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const key = btn.getAttribute('data-key');
          if(!confirm(`Delete license "${key}"?`)) return;
          const arr = (selectedFile.data.licenses || []).filter(x=>x.key!==key);
          await persistLicenses(arr, 'License deleted');
        });
      });

      licenseList.style.display='block';
    }

    async function persistLicenses(newArr, okMsg){
      try{
        // write back to Firestore
        await ls.updateFile(selectedFile.adminId, selectedFile.name, { licenses: newArr });
        // update local state
        selectedFile.data.licenses = newArr;
        renderLicenses();
        showNotification(licenseNotification, okMsg);
      }catch(e){
        console.error(e);
        showNotification(licenseNotification, 'Error updating licenses', true);
      }
    }

    // Export CSV
    btnExportCsv.addEventListener('click', ()=>{
      if(!selectedFile || !(selectedFile.data.licenses||[]).length){
        showNotification(licenseNotification,'No licenses to export',true); return;
      }
      const rows = [['key','createdAt','used','expires']];
      (selectedFile.data.licenses||[]).forEach(l=>{
        rows.push([l.key, l.createdAt||'', String(!!l.used), l.expires||'']);
      });
      const csv = rows.map(r=>r.map(x=>{
        const s = String(x??'');
        return s.includes(',')||s.includes('"') ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${selectedFile.name}-licenses.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification(licenseNotification,'CSV exported');
    });

    /* Render Apps */
    async function renderFiles(){
      try{
        filesTableBody.innerHTML='';
        if(currentAdminRole==="superadmin"){
          const allAdmins = await ls.getAdmins();
          for(const admin of allAdmins){
            const head=document.createElement('tr');
            head.innerHTML = `<td colspan="2" style="background:rgba(0,0,0,.2);font-weight:bold;color:var(--primary)">${admin.email} (${admin.role})</td>`;
            filesTableBody.appendChild(head);
            const files = await ls.readAllFiles(admin.id);
            for(const f of files){
              const paused = f.data.root?.Pause;
              const tr=document.createElement('tr');
              tr.innerHTML = `<td>${f.name}</td><td>${paused?'<span class="badge badge-warning">Paused</span>':'<span class="badge badge-success">Active</span>'}</td>`;
              tr.addEventListener('click', async ()=>{
                try{
                  if(currentAdminRole!=="superadmin" && admin.id!==currentUser.uid){
                    showNotification(userNotification,"You don't have permission to access this app",true); return;
                  }
                  const data = await ls.readFile(admin.id,f.name);
                  selectedFile = {name:f.name,adminId:admin.id,ownerEmail:admin.email,data};
                  currentFile.textContent = "— "+f.name+` (${admin.email})`;
                  btnDeleteFile.disabled=false; clearUserSelection(); updateAppInfo(); renderUsers(); renderLicenses();
                  [...filesTableBody.querySelectorAll('tr')].forEach(r=>r.classList.remove('selected')); tr.classList.add('selected');
                }catch(e){ console.error(e); showNotification(userNotification,"Error loading application data",true); }
              });
              filesTableBody.appendChild(tr);
            }
          }
        }else{
          const files = await ls.readAllFiles(currentUser.uid);
          for(const f of files){
            const paused = f.data.root?.Pause;
            const tr=document.createElement('tr');
            tr.innerHTML = `<td>${f.name}</td><td>${paused?'<span class="badge badge-warning">Paused</span>':'<span class="badge badge-success">Active</span>'}</td>`;
            tr.addEventListener('click', async ()=>{
              try{
                const data = await ls.readFile(currentUser.uid,f.name);
                selectedFile = {name:f.name,adminId:currentUser.uid,ownerEmail:currentUser.email,data};
                currentFile.textContent = "— "+f.name;
                btnDeleteFile.disabled=false; clearUserSelection(); updateAppInfo(); renderUsers(); renderLicenses();
                [...filesTableBody.querySelectorAll('tr')].forEach(r=>r.classList.remove('selected')); tr.classList.add('selected');
              }catch(e){ console.error(e); showNotification(userNotification,"Error loading application data",true); }
            });
            filesTableBody.appendChild(tr);
          }
        }
      }catch(e){ console.error(e); showNotification(userNotification,"Error loading applications",true); }
    }

    /* Render Admins */
    async function renderAdmins(){
      try{
        adminTableBody.innerHTML='';
        if(currentAdminRole!=="superadmin"){
          adminTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px">Only superadmin can manage administrators</td></tr>`;
          return;
        }
        const admins = await ls.getAdmins();
        for(const a of admins){
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${a.email}</td><td>${a.role}</td><td><button class="btn btn-sm btn-primary select-admin" data-id="${a.id}" data-email="${a.email}" data-role="${a.role}">Select</button></td>`;
          adminTableBody.appendChild(tr);
        }
        document.querySelectorAll('.select-admin').forEach(btn=>{
          btn.addEventListener('click',()=>{
            selectedAdmin = { id:btn.dataset.id, email:btn.dataset.email, role:btn.dataset.role };
            adminEmail.value = selectedAdmin.email;
            adminRoleSelect.value = selectedAdmin.role;
            btnUpdateAdmin.disabled=false; btnDeleteAdmin.disabled=false;
          });
        });
      }catch(e){ console.error(e); showNotification(adminNotification,"Error loading administrators",true); }
    }

    /* Save users */
    async function saveUsers(){
      if(!selectedFile) return;
      try{ await ls.writeFile(selectedFile.adminId,selectedFile.name,selectedFile.data); renderUsers(); showNotification(userNotification,"Changes saved successfully"); }
      catch(e){ console.error(e); showNotification(userNotification,"Error saving changes",true); }
    }

    /* User modal */
    function openUserModal(username=null){
      isEditingUser=!!username;
      if(isEditingUser){
        userModalTitle.textContent='Edit User';
        const u = selectedFile.data.users.find(x=>x.Username===username);
        if(u){ modalUsername.value=u.Username; modalPassword.value=''; modalExpires.value=u.Expires||''; modalHwid.value=u.HWID||''; modalUsername.disabled=true; }
      }else{
        userModalTitle.textContent='Add User';
        modalUsername.value=''; modalPassword.value=''; modalExpires.value=''; modalHwid.value=''; modalUsername.disabled=false;
      }
      userModal.style.display='flex';
    }
    async function saveUserFromModal(){
      if(!selectedFile){ showNotification(userNotification,"Please select an application first",true); userModal.style.display='none'; return; }
      const username=modalUsername.value.trim();
      const password=modalPassword.value;
      const expires=modalExpires.value;
      const hwid=modalHwid.value.trim();
      if(!username){ showNotification(userNotification,"Please enter a username",true); return; }
      if(!isEditingUser && !password){ showNotification(userNotification,"Please enter a password",true); return; }
      const users=selectedFile.data.users||[];
      if(isEditingUser){
        const idx=users.findIndex(u=>u.Username===username);
        if(idx<0){ showNotification(userNotification,"User not found",true); return; }
        if(password) users[idx].PasswordHash=password; // demo
        users[idx].Expires=expires||null; users[idx].HWID=hwid||null;
        await saveUsers();
      }else{
        if(users.some(u=>u.Username===username)){ showNotification(userNotification,"Username already exists",true); return; }
        users.push({ Username:username, PasswordHash:password, HWID:hwid||null, Expires:expires||null, IsBanned:false });
        selectedFile.data.users = users; await saveUsers();
      }
      userModal.style.display='none';
    }

    /* License modal + logic */
    function openLicenseModal(){
      if(!selectedFile){ showNotification(licenseNotification,"Please select an application first",true); return; }
      modalLicenseQty.value=5; modalLicensePrefix.value=''; modalLicenseExpires.value='';
      licenseModal.style.display='flex';
    }
    function closeLicenseModal(){ licenseModal.style.display='none'; }

    if(btnOpenLicenseModal){ btnOpenLicenseModal.addEventListener('click', openLicenseModal); }
    btnCancelLicenses.addEventListener('click', closeLicenseModal);
    closeLicenseModalBtn.addEventListener('click', closeLicenseModal);
    window.addEventListener('click',(e)=>{ if(e.target===licenseModal) closeLicenseModal(); });

    btnSaveLicenses.addEventListener('click', async ()=>{
      try{
        if(!selectedFile){ showNotification(licenseNotification,"Please select an application first",true); return; }
        const qty = parseInt(modalLicenseQty.value,10);
        if(isNaN(qty) || qty<1 || qty>100){ showNotification(licenseNotification,"Quantity must be between 1 and 100",true); return; }
        const prefixRaw = modalLicensePrefix.value.trim();
        const prefix = prefixRaw ? prefixRaw.toUpperCase().replace(/\s+/g,'-')+'-' : '';
        const expires = modalLicenseExpires.value || null;

        const newLicenses=[];
        for(let i=0;i<qty;i++){
          const base = generateLicenseKey(selectedFile.name);
          const key = prefix ? (prefix+base) : base;
          newLicenses.push({ key, createdAt:new Date().toISOString(), used:false, expires });
        }

        // Save to Firestore and merge in local state
        const appRefreshed = await ls.addLicenses(selectedFile.adminId,selectedFile.name,newLicenses);
        selectedFile.data.licenses = appRefreshed;

        showNotification(licenseNotification, `${qty} license(s) generated successfully`);
        closeLicenseModal();
        renderLicenses();
      }catch(e){ console.error(e); showNotification(licenseNotification,'Error generating licenses',true); }
    });

    [modalLicenseQty,modalLicensePrefix,modalLicenseExpires].forEach(inp=>{
      inp.addEventListener('keypress',e=>{ if(e.key==='Enter') btnSaveLicenses.click(); });
    });

    // license search
    licenseSearch.addEventListener('input', ()=>{
      licenseFilter = licenseSearch.value;
      renderLicenses();
    });

    // manual refresh
    btnRefreshLicenses.addEventListener('click', async ()=>{
      if(!selectedFile){ showNotification(licenseNotification,"Select an app first",true); return; }
      const fresh = await ls.readFile(selectedFile.adminId, selectedFile.name);
      selectedFile.data.licenses = fresh.licenses || [];
      renderLicenses();
    });

    /* Buttons */
    btnBan.onclick = async ()=>{ if(!selectedFile||!selectedUsername) return; const u=selectedFile.data.users.find(x=>x.Username===selectedUsername); if(u){u.IsBanned=true; await saveUsers();} };
    btnUnban.onclick = async ()=>{ if(!selectedFile||!selectedUsername) return; const u=selectedFile.data.users.find(x=>x.Username===selectedUsername); if(u){u.IsBanned=false; await saveUsers();} };
    btnResetHWID.onclick = async ()=>{ if(!selectedFile||!selectedUsername) return; const u=selectedFile.data.users.find(x=>x.Username===selectedUsername); if(u){u.HWID=null; await saveUsers();} };
    inpSearch.addEventListener('input',()=>{ filterText=inpSearch.value; renderUsers(); });

    btnCreateFile.onclick = async ()=>{
      const name = inpFileName.value.trim();
      if(!name){ showNotification(userNotification,"Please enter an application name",true); return; }
      const files = currentUser ? await ls.readAllFiles(currentUser.uid) : [];
      if(files.some(f=>f.name===name)){ showNotification(userNotification,"Application already exists",true); return; }
      try{
        await ls.writeFile(currentUser.uid,name,{ users:[], root:{ Pause:false, AppVersion:"1.0", CheckHWID:true }, licenses:[] });
        inpFileName.value=''; await renderFiles(); showNotification(userNotification,`Application "${name}" created`);
      }catch(e){ console.error(e); showNotification(userNotification,"Error creating application",true); }
    };

    btnDeleteFile.onclick = async ()=>{
      if(!selectedFile) return;
      if(!confirm(`Are you sure you want to delete application "${selectedFile.name}"? This will delete all users and licenses!`)) return;
      try{
        await ls.deleteFile(selectedFile.adminId,selectedFile.name);
        selectedFile=null; currentFile.textContent="— No App Selected"; btnDeleteFile.disabled=true;
        usersTableBody.innerHTML=''; licenseList.style.display='none'; licenseAppInfo.textContent=''; updateAppInfo(); await renderFiles();
        showNotification(userNotification,"Application deleted");
      }catch(e){ console.error(e); showNotification(userNotification,"Error deleting application",true); }
    };

    btnRefreshFiles.onclick = ()=>renderFiles();
    btnPause.onclick = async ()=>{ if(!selectedFile) return; try{ await ls.updateFile(selectedFile.adminId,selectedFile.name,{"root.Pause":true}); selectedFile.data.root ||= {}; selectedFile.data.root.Pause=true; await renderFiles(); showNotification(userNotification,"Application paused"); }catch(e){ console.error(e); showNotification(userNotification,"Error pausing application",true); } };
    btnResume.onclick = async ()=>{ if(!selectedFile) return; try{ await ls.updateFile(selectedFile.adminId,selectedFile.name,{"root.Pause":false}); selectedFile.data.root ||= {}; selectedFile.data.root.Pause=false; await renderFiles(); showNotification(userNotification,"Application resumed"); }catch(e){ console.error(e); showNotification(userNotification,"Error resuming application",true); } };

    /* Settings modal */
    btnEditSettings.onclick = ()=>{
      if(!selectedFile) return;
      appVersionInput.value = selectedFile.data.root?.AppVersion || "1.0";
      hwidCheckToggle.checked = selectedFile.data.root?.CheckHWID !== false;
      settingsModal.style.display='flex';
    };
    btnSaveSettings.onclick = async ()=>{
      if(!selectedFile) return;
      try{
        const appVersion = (appVersionInput.value||"1.0").trim();
        const checkHWID = hwidCheckToggle.checked;
        await ls.updateFile(selectedFile.adminId,selectedFile.name,{"root.AppVersion":appVersion,"root.CheckHWID":checkHWID});
        selectedFile.data.root ||= {}; selectedFile.data.root.AppVersion=appVersion; selectedFile.data.root.CheckHWID=checkHWID;
        updateAppInfo(); settingsModal.style.display='none'; showNotification(userNotification,"App settings updated successfully");
      }catch(e){ console.error(e); showNotification(userNotification,"Error updating app settings",true); }
    };
    btnCloseModal.onclick = ()=>settingsModal.style.display='none';
    closeModalBtn.onclick = ()=>settingsModal.style.display='none';

    /* User modal buttons */
    document.getElementById('btnAddUserModal').onclick = ()=>{ if(!selectedFile){ showNotification(userNotification,"Please select an application first",true); return;} openUserModal(); };
    btnSaveUser.onclick = ()=>saveUserFromModal();
    btnCancelUser.onclick = ()=>userModal.style.display='none';
    closeUserModalBtn.onclick = ()=>userModal.style.display='none';

    /* Theme */
    themeToggle.addEventListener('click',()=>{
      if(themeToggle.innerHTML.includes('fa-moon')){
        themeToggle.innerHTML='<i class="fas fa-sun"></i>';
        document.body.style.background='linear-gradient(135deg,#0f1a3d,#7a1631,#c97f1a)';
      }else{
        themeToggle.innerHTML='<i class="fas fa-moon"></i>';
        document.body.style.background='linear-gradient(135deg,var(--darker) 0%,var(--dark) 100%)';
      }
    });

    /* Auth */
    btnLogin.addEventListener('click', async ()=>{
      const email=loginEmail.value.trim(); const password=loginPassword.value;
      if(!email||!password){ showNotification(loginNotification,"Please enter both email and password",true); return; }
      try{ showNotification(loginNotification,"Logging in..."); await signInWithEmailAndPassword(auth,email,password); showNotification(loginNotification,"Login successful!"); }
      catch(e){ console.error(e); showNotification(loginNotification,"Invalid email or password!",true); }
    });
    document.getElementById('loginPassword').addEventListener('keypress',e=>{ if(e.key==='Enter') btnLogin.click(); });

    logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); showNotification(loginNotification,"Logged out successfully"); }catch(e){ console.error(e); showNotification(loginNotification,"Error during logout",true); } });

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        loginPage.style.display='none'; appPage.style.display='block'; userEmail.textContent=user.email; currentUser=user;
        const adminData = await ls.getAdmin(user.uid);
        if(adminData){ currentAdminRole=adminData.role; document.querySelector('[data-tab="admin"]').style.display = (adminData.role==='superadmin')?'block':'none'; }
        else{
          await setDoc(doc(db,"admins",user.uid),{email:user.email,role:"admin",createdAt:serverTimestamp()});
          currentAdminRole="admin"; document.querySelector('[data-tab="admin"]').style.display='none';
        }
        renderFiles(); renderAdmins();
      }else{
        loginPage.style.display='flex'; appPage.style.display='none';
        selectedFile=null; currentFile.textContent="— No App Selected"; currentUser=null; currentAdminRole="user";
        usersTableBody.innerHTML=''; licenseList.style.display='none'; licenseAppInfo.textContent='';
      }
    });
  </script>
</body>
</html>
